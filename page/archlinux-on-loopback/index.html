<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Phoenix Nemo">
    <meta name="description" content="MinoriWiki demo site">
    <title>
                Install ArchLinux onto loopback filesystem - MinoriWiki Demo            </title>
    <link href="/MinoriWiki/assets/bootstrap.min.css" rel="stylesheet"/>
    <link href="/MinoriWiki/assets/style.css" rel="stylesheet"/>
    <script src="/MinoriWiki/assets/highlight.min.js"></script>
    <base target="_blank">
</head>
<body>
<div class="container">
    <div class="page-header">
                <h1><a href="/MinoriWiki/" class="logo-text" target="_self">MinoriWiki Demo</a>&nbsp;
                        <small>/ Install ArchLinux onto loopback filesystem</small>
                    </h1>
            </div>
<div class="row">
<!-- two columns -->
<div class="col-lg-3 col-md-3">
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">About</h3>
    </div>
    <div class="panel-body">
		<p>This is the demo site of <a href="https://github.com/phoenixlzx/MinoriWiki">MinoriWiki</a></p>
		<p>And a partial mirror of <a href="https://felixc.at">FelixWiki</a>.</p>
    </div>
</div>
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">Navigation</h3>
    </div>
    <div class="panel-body">
        <h6><a href="/MinoriWiki/" target="_self">Homepage</a></h6>
                <h5>Server Configuration</h5>
        <ul class="list-unstyled">
                        <li>
                <a href="/MinoriWiki/page/DNSMasq" target="_self">
                                        DNSMasq                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/MongoDB" target="_self">
                                        MongoDB                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/PHP" target="_self">
                                        PHP                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/SSH" target="_self">
                                        SSH                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/Nginx" target="_self">
                                        Nginx                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/Linux/Security" target="_self">
                                                            Linux / Linux Security                                    </a>
            </li>
                    </ul>
                <h5>Network Operation</h5>
        <ul class="list-unstyled">
                        <li>
                <a href="/MinoriWiki/page/DoS" target="_self">
                                        DoS                                    </a>
            </li>
                    </ul>
                <h5>Network Configuration</h5>
        <ul class="list-unstyled">
                        <li>
                <a href="/MinoriWiki/page/NAT" target="_self">
                                        NAT                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/PortForwarding" target="_self">
                                        PortForwarding                                    </a>
            </li>
                    </ul>
                <h5>Desktop Related</h5>
        <ul class="list-unstyled">
                        <li>
                <a href="/MinoriWiki/page/Tmux" target="_self">
                                        Tmux                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/URxvt" target="_self">
                                        URxvt                                    </a>
            </li>
                    </ul>
                <h5>Arch Linux</h5>
        <ul class="list-unstyled">
                        <li>
                <a href="/MinoriWiki/page/archlinux-on-loopback" target="_self">
                                        Install ArchLinux onto loopback filesystem                                    </a>
            </li>
                    </ul>
                <h5>Uncategoried</h5>
        <ul class="list-unstyled">
                        <li>
                <a href="/MinoriWiki/page/testv1" target="_self">
                                        testv1                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/testv2" target="_self">
                                        testv2                                    </a>
            </li>
                        <li>
                <a href="/MinoriWiki/page/Test-Page" target="_self">
                                        Formatting Test Page                                    </a>
            </li>
                    </ul>
                        <hr/>
        <a href="/MinoriWiki/changelog">Changelog</a>
            </div>
</div>
</div>
<div class="col-lg-9 col-md-9 col-sm-12">
<div class="index-content">
<div class="row">
<span class="label label-primary pull-right">Arch Linux</span>
</div>
<div class="row">
<pre><code>mkdir /host
ntfs-3g /dev/sda5 /host
truncate -s 8G /host/diskimg/archlinux.img
mkfs -t ext4 -F /host/diskimg/archlinux.img
modprobe loop # You need this if not using official installation media
mount -o loop /host/diskimg/archlinux.img /mnt
mkdir -p /mnt/var/lib/pacman
vi /etc/pacman.d/mirrorlist
pacman -Sy
pacman -Syr /mnt
pacman -Sr /mnt base ntfs-3g net-tools wireless_tools
vi /mnt/etc/rc.conf
vi /mnt/etc/mkinitcpio.conf
mv /mnt/boot /host/diskimg/archboot
ln -s /host/diskimg/archboot /mnt/boot
</code></pre>
<p><code>/mnt/lib/initcpio/hooks/looproot</code></p>
<pre><code># vim:set ft=sh:
run_hook ()
{
    # Now mount the host filesystem
    mkdir /host
    # mount -t ntfs /dev/sda5 /host
    ntfs-3g /dev/sda5 /host

    # And the loop filesystem
    losetup /dev/loop0 /host/diskimg/archlinux.img
    mount -t ext4 /host/diskimg/archlinux.img /new_root
    mount --bind /host /new_root/host
}
</code></pre>
<p><code>/mnt/lib/initcpio/install/looproot</code></p>
<pre><code>build() {
        SCRIPT=&quot;looproot&quot;
}

help() {
        cat &lt;&lt;HELPEOF
        HELPEOF
}

# vim: set ft=sh ts=4 sw=4 et:
</code></pre>
<p><code>/mnt/etc/rc.d/functions.d/omitntfs</code></p>
<pre><code>omitntfs() {
    sync
    add_omit_pids $(fuser /dev/sda5 2&gt;/dev/null | awk '-F ' '{ print $1 }')
}

# remove fuseblk from the original NETFS variable
NETFS=&quot;nfs,nfs4,smbfs,cifs,codafs,ncpfs,shfs,fuse,glusterfs,davfs,fuse.glusterfs&quot;

add_hook shutdown_prekillall omitntfs
add_hook single_prekillall omitntfs
</code></pre>
<p><code>/mnt/etc/mkinitcpio.conf</code> (diff)</p>
<pre><code>7c7
&lt; MODULES=&quot;&quot;
---
&gt; MODULES=&quot;loop fuse&quot;
14c14
&lt; BINARIES=&quot;&quot;
---
&gt; BINARIES=&quot;/usr/bin/ntfs-3g&quot;
59c59
&lt; HOOKS=&quot;base udev autodetect pata scsi sata filesystems usbinput fsck&quot;
---
&gt; HOOKS=&quot;base udev autodetect pata scsi sata filesystems usbinput looproot fsck&quot;
</code></pre>
<p><code>/mnt/etc/fstab</code></p>
<pre><code># 
# /etc/fstab: static file system information
#
# &lt;file system&gt; &lt;dir&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
/dev/loop0      /       ext4    loop            0       1
/dev/sda5       /host   ntfs    defaults        0       0
</code></pre>
<pre><code>mkdir /mnt/host
for i in dev proc sys host; do mount --bind /$i /mnt/$i; done
modprobe dm-mod # You need this if you want to install GRUB
chroot /mnt
passwd
mkinitcpio -p linux
</code></pre>
<p>(Install the bootloader)</p>
<p>After installing the bootloader</p>
<pre><code>exit
umount /mnt/dev /mnt/proc /mnt/sys /mnt/host /mnt /host
reboot
</code></pre>
<p>After reboot</p>
<pre><code>exit
</code></pre>
<p><em>Last Update: Sat Oct 15 2016 09:31:15 GMT+0900 (JST)</em>  <a href="/MinoriWiki/raw/archlinux-on-loopback.md">Source File</a></p>
</div>
<div class="row">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'minoriwikidemo';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
</div>
</div>
</div>
</div>
<div class="footer">
    <div class="footer-text">
        <p>
            MinoriWiki Demo using <a href="https://github.com/phoenixlzx/MinoriWiki" target="_blank">MinoriWiki</a>
        </p>
    </div>
</div>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
